%% top of barrier model for ballistic FETsclose allclear allclcinput_file;assign_parameters;ticfor kk= 1:n_Angl    for jj = 1:n_Vg        for ii = 1:n_Vd            Vgj=Vg(jj);	        Vdi=Vd(ii);	        UL=-(alphag*Vgj)-(alphad*Vdi);  % Laplace potential            UP=0;                           % Poisson potential            Uscf=UL+UP;                     % Self-consistent potential	        dU=1;            % Velocity components in the transport direction            Vel=Vel_x*cosd(Angl(kk))+...                Vel_y*sind(Angl(kk));            II_pos=find(Vel>=0);            II_neg=find(Vel<0);            mu(II_pos)=Ef;            mu(II_neg)=Ef-Vdi;            counter=0;	        while dU>.001                                for ll=1:num_bands                    ferm(:,:,ll)=(1./(1+exp((squeeze(E(:,:,ll))+Uscf-...                        squeeze(mu(:,:,ll)))/kT)));                    N(:,:,ll)=n_states*ferm(:,:,ll);                    A_tmp=isnan(N(:,:,ll));                    A_tmp=find(A_tmp==1);                    N_tmp=N(:,:,ll);                    N_tmp(A_tmp)=0;                    Nll(ii,jj,kk,ll) = 2*sum(sum( N_tmp));                    % note: valley degeneracy 'NOT' hardwired                    dN(ii,jj,kk,ll)=Nll(ii,jj,kk,ll)-N0ii(ll);                end                		        UPnew=U0*sum(squeeze(dN(ii,jj,kk,:)));                dU=abs(UP-UPnew);		        UP=UP+0.1*(UPnew-UP);                Uscf=UL+UP;                counter=counter+1;                %fprintf('%i: %.3e %.2fs\n',counter,dU,toc);	        end            Uscf_mat(ii,jj,kk)=Uscf;            for ll=1:num_bands                I_tmp=q*(n_states*(squeeze(ferm(:,:,ll).*...                    squeeze(Vel(:,:,ll)))));                NQ(ii,jj,kk,ll)=sum(sum(q*(n_states*(squeeze(ferm(:,:,ll))))));                A_tmp=isnan(I_tmp);                A_tmp=find(A_tmp==1);                I_tmp(A_tmp)=0;           	    I(ii,jj,kk,ll)=sum(sum(I_tmp));            end        end    end    tocendtocI=squeeze(I); %sum(I)dN=squeeze(dN);I_constant=1;%semilogy(Vg,I_constant*squeeze(I(:,:,1)),'k')%surf(Vd,Vg,log10(I)')%{figure[r, theta]=meshgrid(Vg,Angl/180*pi);XM=r.*cos(theta);YM=r.*sin(theta);pcolor(XM,YM,(I_constant*I)')%}%{figuresubplot(2,2,[1 2])plot([kx_plot(1:10) ky_plot(11:21)],[E_all(11,1:10) E_all(11:21,11)'])hold on;plot([kx_plot(1) ky_plot(21)],(Ef-Uscf_mat(1))*[1 1],'k--')subplot(2,2,[3 4])plot([kx_plot(1:10) ky_plot(11:21)],[E_all(11,1:10) E_all(11:21,11)'])hold on;plot([kx_plot(1) ky_plot(21)],(Ef-Uscf_mat(end))*[1 1],'k--')%}% save results.mat -mat%plot_fig;disp('End of file')